<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/iron-input/iron-input.html">

<link rel="import" href="../modules/mooc-category.html">
<link rel="import" href="../modules/mooc-highlight.html">
<link rel="import" href="../modules/mooc-event-list.html">

<!--REST calls-->
<link rel="import" href="../api.html">



<dom-module id="mooc-page-eventList">
    <template>
        <style >

        </style>
        <events-api id="api"></events-api>
        <mooc-search id="searchPane"></mooc-search>
        <div class="main-page">
            <div class="left-pane">
                <mooc-category id="category"></mooc-category>
                <mooc-highlight id="highlight"></mooc-highlight>
            </div>
            <div class="center-pane">
                <mooc-event-list id="eventList"></mooc-event-list>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'mooc-page-eventList',
            ready : function() {
                var that=this;
                this.$.api.addEventListener('onSuccess', function(event) {
                    that.ALL_EVENTS = that.consolidateEvents(event.detail.eventsFull);
                    that.$.eventList.setValues(that.ALL_EVENTS);
                    that.$.highlight.setValues(that.findEvents(['E0-001-078953426-3','E0-001-088571106-5','E0-001-087698129-1','E0-001-088210921-4'],that.ALL_EVENTS));


                });
                this.$.category.addEventListener('onCategoryChanged', function(event) {
                    that.$.eventList.setValues(that.filterEvents(event.detail.selection,that.$.searchPane.criteria));
                });
                this.$.searchPane.addEventListener('onSearchChanged', function(event) {
                    that.$.eventList.setValues(that.filterEvents(that.$.category.createSelectionObject(),that.$.searchPane.criteria));
                });



                //set all events on display
                this.$.api.loadEvents()
            },
            findEvents: function(eventIds, fullList) {
                var res= [];
                for (var eventId in eventIds) {
                    var id = eventIds[eventId];
                    for (var eventNb in fullList) {
                        var event = fullList[eventNb];
                        if (event.id && event.id===id) {
                            res.push(event);
                        }
                    }
                }
                return res;
            },

            consolidateEvents : function(eventList) {
                var res= [];
                for (var eventIndex in eventList ) {//eventList ) {
                   var eventFull=eventList [eventIndex];
                    if (this.consolidateEvent(eventFull)) {
                        res.push(eventFull);
                    }
                }
                return res;

            },
            consolidateEvent: function(eventFull) {
                if( ! eventFull.title || 0 === eventFull.title.length ) {
                    eventFull["title"]="NOT DEFINED";
                    console.log("TITLE UNDEFINED");
                    return false;
                }

                if( ! eventFull.start_time || ! eventFull.start_time instanceof Date ) {
                    eventFull["date"]="NOT DEFINED";
                    console.log("date UNDEFINED");
                    return false;
                }
                else {
                    eventFull["date"]=eventFull.start_time;
                }
                if( !eventFull.image || ! eventFull.image.block200.url) {
                    eventFull["img"]="tbd";
                    console.log("img UNDEFINED");
                    return false;
                }
                else {
                    eventFull["img"]=eventFull.image.block200.url;
                }
                if (!eventFull["id"]) {
                    eventFull["eventId"]="UNKNOWN ID";
                }
                else {
                    eventFull["eventId"]=eventFull["id"];
                }
                return true;

            },

            filterEvents: function(categories,searchCriteria) {
                result = [];
                for(var event in this.ALL_EVENTS) {
                    var currEvent=this.ALL_EVENTS[event];

                    if (this.isEventOnCategory(currEvent,categories) && this.isEventOnSearch(currEvent,searchCriteria))
                    {
                        result.push(currEvent);
                    }
                }
                return result;
            },

            isEventOnCategory : function(event,category) {
                if (! event.category ) { return category.ALL; }
                if (category.ALL) { return true;}

                if (event.category == "CON" && category.CON) {return true; }
                if (event.category == "FES" && category.FES) {return true; }
                if (event.category == "COM" && category.COM) {return true; }
                if (event.category == "FAM" && category.FAM) {return true; }
                return false;
            },
            isEventOnSearch: function(event,searchCriteria) {
                var ok = true;
                if (!searchCriteria) return true;
                if ( searchCriteria.nom && !(0===searchCriteria.nom.trim().length)  ) {
                    ok =this.match(searchCriteria.nom,event.title);

                }
                if (!ok) return false;
                if ( searchCriteria.lieu && !(0===searchCriteria.lieu.trim().length)  ) {
                    ok = this.match(searchCriteria.lieu,event.lieu);
                }
                if (!ok) return false;
                return true;
            },

            match : function(subStr, mainStr) {
                console.log("Search :"+subStr+" into "+mainStr);
                if (!subStr || !mainStr) return false;
                return mainStr.toLowerCase().indexOf(subStr.toLowerCase()) > -1;
            },



            ALL_EVENTS : [
                {"title":"Op√©ra de Paris",category:"CON", "date":"02/05/2015","img":"./img/default-event.png"},
                {"title":"Summer Festival",category:"FES", "date":"02/05/2015","img":"./img/default-event.png"},
                {"title":"Canteloup sort du bois",category:"COM", "date":"02/05/2015","img":"./img/default-event.png"},
                {"title":"PETER PAN",category:"FAM", "date":"02/05/2015","img":"./img/default-event.png"},
                {"title":"UNCATOGORIZED", "date":"02/05/2015","img":"./img/default-event.png"},
                {"title":"UNCATOGORIZED", "date":"02/05/2015","img":"./img/default-event.png"},
                {"title":"UNCATOGORIZED", "date":"02/05/2015","img":"./img/default-event.png"},
                {"title":"UNCATOGORIZED", "date":"02/05/2015","img":"./img/default-event.png"}

            ]

        });
    </script>
</dom-module>
